pipeline {
    parameters {
	string(
	    defaultValue: 'mr-cool',
	    description: 'The name of the user to launch the ec2 instance.',
	    name: 'User')
    }
    environment {
	USER = "${params.User}"
    }
    options {
        gitLabConnection('code.usgs.gov')
    }
    triggers {
        gitlab( triggerOnPush: true,
               triggerOnMergeRequest: true,
               branchFilterType: 'NameBasedFilter',
               skipWorkInProgressMergeRequest: true,
               ciSkip: true,
               setBuildDescription: true)
    }
    agent {
	node {
	    label "ansible"
	}
    }
    stages {
	stage('Run EC2 playbook') {
	    steps {
		script {
		    withCredentials([[
			$class: 'AmazonWebServicesCredentialsBinding',
			credentialsId: 'jenkins-deploy',
			accessKeyVariable: 'AWS_ACCESS_KEY_ID',
			secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
		    ]]) {
			sh '''
			    printenv
			    '''
			ansiColor('xterm') {
			    ansiblePlaybook(
				colorized: true,
				inventory: 'hosts',
				credentialsId: 'jenkins-master-key',
				hostKeyChecking: false,
				playbook: 'playbook_ec2.yml'
			    )
			}
		    }
		}
	    }
	}
    }
}
