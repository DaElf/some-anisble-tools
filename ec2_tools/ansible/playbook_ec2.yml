- name: Create a new EC2 instance
  hosts: localhost
  connection: local
  gather_facts: False

  vars:
    region: us-west-2
    instance_type: t2.large
    ami: ami-6cd6f714  # AWS Linux  2
    subnet: subnet-044c596c6b1ad7906
    security_group: sg-0c305038ba5d8d1fb
    username: "{{ lookup('env','USER') }}"
    keypair: jenkins-master # pem file name
    name_tag: "{{ username }}-devel"
    vol_size: 32
    proj_tag: l2pgsv2

  roles:
    - ec2-instance

  tasks:
  - name: Get EC2 IP
    ec2_instance_facts:
      region: "us-west-2"
      filters:
        "tag:Name": "{{ username }}-devel"
        instance-state-name: running
    register: ec2_info

  - name: Store EC2 IP
    lineinfile:
      path: hosts
      regexp: 'aws-devel-instance*'
      line: 'aws-devel-instance ansible_ssh_extra_args="-o StrictHostKeyChecking=no" ansible_ssh_host={{ item }}'
    with_items: "{{ ec2_info.instances[0].private_ip_address }}"
#    with_items: "{{ ec2_info.instances[0].private_ip_address }}"
